# ---------- http 컨텍스트(서버블록 밖) ----------
# 허용 Origin만 되돌려주고, 아니면 빈 값
map $http_origin $cors_allow_origin {
    default "";
    "~^https://(www\.)?growing\.ai\.kr$" $http_origin;
}

# 업스트림 이름을 서비스명과 구분 (헷갈림 방지)
upstream backend_upstream {
    server backend:8000;     # ← 백엔드 컨테이너 포트 명시
    keepalive 64;
}

server {
    listen 80;
    server_name api.growing.ai.kr;

    # 헬스체크
    location = /health {
        add_header Content-Type text/plain;
        return 200 "ok\n";
    }

    location / {
        # Preflight는 Nginx가 직접 응답
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin $cors_allow_origin always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, Accept, Origin" always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Vary "Origin" always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }

        # 백엔드가 보내는 CORS 헤더는 숨김(중복 방지) — 대소문자 한 줄이면 충분
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Credentials;
        proxy_hide_header Access-Control-Expose-Headers;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header Access-Control-Allow-Methods;

        # 업스트림으로 프록시 (명시적으로 8000에 붙음)
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host              $host;               # 고정하고 싶으면 api.growing.ai.kr 도 OK
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;  # ALB가 준 proto 유지
        proxy_connect_timeout 60s;
        proxy_send_timeout    300s;
        proxy_read_timeout    300s;

        proxy_pass http://backend_upstream;

        # 실요청에도 Nginx가 '정확히 1회만' CORS 추가
        add_header Access-Control-Allow-Origin $cors_allow_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Vary "Origin" always;
    }
}
